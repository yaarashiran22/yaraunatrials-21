<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yara BA - Database Export</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px; 
      margin: 0 auto; 
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #00d4ff; }
    .btn {
      background: #00d4ff;
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 8px;
      font-weight: 600;
    }
    .btn:hover { background: #00b8e6; }
    .btn:disabled { background: #666; cursor: not-allowed; }
    .status { 
      background: #2a2a4e; 
      padding: 16px; 
      border-radius: 8px; 
      margin: 16px 0;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    .section { margin: 24px 0; }
    .warning { color: #ffcc00; }
  </style>
</head>
<body>
  <h1>üóÑÔ∏è Yara BA Database Export</h1>
  
  <div class="section">
    <h2>Export Tables as SQL</h2>
    <p>Click a button to generate and download SQL INSERT statements for each table.</p>
    
    <button class="btn" onclick="exportTable('events')">üìÖ Export Events (311 rows)</button>
    <button class="btn" onclick="exportTable('whatsapp_users')">üë• Export WhatsApp Users (454 rows)</button>
    <button class="btn" onclick="exportTable('whatsapp_conversations')">üí¨ Export Conversations (5,079 rows)</button>
    <button class="btn" onclick="exportTable('top_list_items')">üìã Export Top List Items (103 rows)</button>
    <button class="btn" onclick="exportTable('expired_events')">üì¶ Export Expired Events (56 rows)</button>
  </div>

  <div class="section">
    <h2>Export All Tables</h2>
    <button class="btn" onclick="exportAllTables()">üì¶ Export Complete Database</button>
  </div>

  <div id="status" class="status">Ready to export...</div>

  <script>
    const SUPABASE_URL = 'https://nxtfugcmatkiqjzxucgh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54dGZ1Z2NtYXRraXFqenh1Y2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTYwMDksImV4cCI6MjA3MzY5MjAwOX0.e_n6yYVOCU6eRV0WS9BmogxgqN_ZPViBBmEkfI2ZI_s';
    
    let supabaseClient = null;
    const statusEl = document.getElementById('status');

    // Initialize Supabase client when page loads
    document.addEventListener('DOMContentLoaded', function() {
      if (window.supabase && window.supabase.createClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        log('‚úÖ Supabase client initialized');
      } else {
        log('‚ùå Error: Supabase library not loaded. Please refresh the page.');
      }
    });

    function log(msg) {
      statusEl.textContent += '\n' + msg;
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    function escapeSQL(val) {
      if (val === null || val === undefined) return 'NULL';
      if (typeof val === 'boolean') return val ? 'TRUE' : 'FALSE';
      if (typeof val === 'number') return val.toString();
      if (Array.isArray(val)) {
        return `ARRAY[${val.map(v => `'${String(v).replace(/'/g, "''")}'`).join(', ')}]::text[]`;
      }
      if (typeof val === 'object') {
        return `'${JSON.stringify(val).replace(/'/g, "''")}'::jsonb`;
      }
      return `'${String(val).replace(/'/g, "''")}'`;
    }

    function generateInsertSQL(tableName, rows, excludeColumns = ['embedding']) {
      if (!rows.length) return `-- No data in ${tableName}\n`;
      
      const columns = Object.keys(rows[0]).filter(c => !excludeColumns.includes(c));
      let sql = `-- =====================================================\n`;
      sql += `-- TABLE: ${tableName} (${rows.length} rows)\n`;
      sql += `-- Exported: ${new Date().toISOString()}\n`;
      sql += `-- =====================================================\n\n`;
      
      for (const row of rows) {
        const values = columns.map(col => escapeSQL(row[col]));
        sql += `INSERT INTO public.${tableName} (${columns.join(', ')}) VALUES (${values.join(', ')}) ON CONFLICT (id) DO NOTHING;\n`;
      }
      
      return sql;
    }

    async function fetchAllRows(tableName) {
      if (!supabaseClient) {
        throw new Error('Supabase client not initialized. Please refresh the page.');
      }
      
      let allRows = [];
      let offset = 0;
      const limit = 1000;
      
      while (true) {
        const { data, error } = await supabaseClient
          .from(tableName)
          .select('*')
          .range(offset, offset + limit - 1);
        
        if (error) throw error;
        if (!data || data.length === 0) break;
        
        allRows = allRows.concat(data);
        log(`Fetched ${allRows.length} rows from ${tableName}...`);
        
        if (data.length < limit) break;
        offset += limit;
      }
      
      return allRows;
    }

    async function exportTable(tableName) {
      try {
        statusEl.textContent = `Exporting ${tableName}...`;
        
        const rows = await fetchAllRows(tableName);
        log(`Total: ${rows.length} rows`);
        
        const sql = generateInsertSQL(tableName, rows);
        
        const blob = new Blob([sql], { type: 'text/sql' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${tableName}_backup_${new Date().toISOString().split('T')[0]}.sql`;
        a.click();
        URL.revokeObjectURL(url);
        
        log(`‚úÖ Downloaded ${tableName}_backup.sql`);
      } catch (err) {
        log(`‚ùå Error: ${err.message}`);
      }
    }

    async function exportAllTables() {
      const tables = [
        'profiles', 'events', 'items', 'top_lists', 'top_list_items',
        'whatsapp_users', 'whatsapp_conversations', 'whatsapp_user_interactions',
        'expired_events', 'event_rsvps', 'join_requests', 'chatbot_errors',
        'communities', 'notifications', 'posts', 'user_coupons', 
        'user_following', 'user_friends', 'user_locations', 'profile_photos'
      ];
      
      statusEl.textContent = 'Exporting all tables...';
      let fullSQL = `-- =====================================================\n`;
      fullSQL += `-- YARA BA COMPLETE DATABASE BACKUP\n`;
      fullSQL += `-- Exported: ${new Date().toISOString()}\n`;
      fullSQL += `-- =====================================================\n\n`;
      
      for (const table of tables) {
        try {
          log(`Exporting ${table}...`);
          const rows = await fetchAllRows(table);
          fullSQL += generateInsertSQL(table, rows);
          fullSQL += '\n';
        } catch (err) {
          log(`‚ö†Ô∏è Skipped ${table}: ${err.message}`);
        }
      }
      
      const blob = new Blob([fullSQL], { type: 'text/sql' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `yara_ba_full_backup_${new Date().toISOString().split('T')[0]}.sql`;
      a.click();
      URL.revokeObjectURL(url);
      
      log(`\n‚úÖ Complete backup downloaded!`);
    }

    // Make functions globally available
    window.exportTable = exportTable;
    window.exportAllTables = exportAllTables;
  </script>
</body>
</html>
